/**
 * @license React
 * react-server-dom-webpack-plugin.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

'use strict';

'use strict';var p=require("path"),r=require("url"),y=require("neo-async"),z=require("webpack/lib/dependencies/ModuleDependency"),A=require("webpack/lib/dependencies/NullDependency"),B=require("webpack/lib/Template"),C=require("webpack");const D=Array.isArray;class E extends z{constructor(b){super(b)}get type(){return"client-reference"}}const F=require.resolve("../client.browser.js");
class G{constructor(b){this.ssrManifestFilename=this.clientManifestFilename=this.chunkName=this.clientReferences=void 0;if(!b||"boolean"!==typeof b.isServer)throw Error("React Server Plugin: You must specify the isServer option as a boolean.");if(b.isServer)throw Error("TODO: Implement the server compiler.");b.clientReferences?"string"!==typeof b.clientReferences&&D(b.clientReferences)?this.clientReferences=b.clientReferences:this.clientReferences=[b.clientReferences]:this.clientReferences=[{directory:".",
recursive:!0,include:/\.(js|ts|jsx|tsx)$/}];"string"===typeof b.chunkName?(this.chunkName=b.chunkName,/\[(index|request)\]/.test(this.chunkName)||(this.chunkName+="[index]")):this.chunkName="client[index]";this.clientManifestFilename=b.clientManifestFilename||"react-client-manifest.json";this.ssrManifestFilename=b.ssrManifestFilename||"react-ssr-manifest.json"}apply(b){const l=this;let n,t=!1;b.hooks.beforeCompile.tapAsync("React Server Plugin",(c,a)=>{c=c.contextModuleFactory;const e=b.resolverFactory.get("context",
{});l.resolveAllClientFiles(b.context,e,b.inputFileSystem,c,function(d,g){d?a(d):(n=g,a())})});b.hooks.thisCompilation.tap("React Server Plugin",(c,a)=>{a=a.normalModuleFactory;c.dependencyFactories.set(E,a);c.dependencyTemplates.set(E,new A.Template);c=e=>{e.hooks.program.tap("React Server Plugin",()=>{const d=e.state.module;if(d.resource===F&&(t=!0,n))for(let h=0;h<n.length;h++){const m=n[h];var g=l.chunkName.replace(/\[index\]/g,""+h).replace(/\[request\]/g,B.toPath(m.userRequest));g=new C.AsyncDependenciesBlock({name:g},
null,m.request);g.addDependency(m);d.addBlock(g)}})};a.hooks.parser.for("javascript/auto").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/esm").tap("HarmonyModulesPlugin",c);a.hooks.parser.for("javascript/dynamic").tap("HarmonyModulesPlugin",c)});b.hooks.make.tap("React Server Plugin",c=>{c.hooks.processAssets.tap({name:"React Server Plugin",stage:C.Compilation.PROCESS_ASSETS_STAGE_REPORT},function(){if(!1===t)c.warnings.push(new C.WebpackError("Client runtime at react-server-dom-webpack/client was not found. React Server Components module map file "+
l.clientManifestFilename+" was not created."));else{var a={},e={};c.chunkGroups.forEach(function(g){function h(k,f){if(/\.(js|ts)x?$/.test(f.resource)){var q=c.moduleGraph.getExportsInfo(f).getProvidedExports(),u={},x={},w=r.pathToFileURL(f.resource).href;void 0!==w&&(["","*"].concat(Array.isArray(q)?q:[]).forEach(function(v){u[v]={id:k,chunks:m,name:v};x[v]={specifier:w,name:v}}),a[w]=u,e[k]=x)}}const m=g.chunks.map(function(k){return k.id});g.chunks.forEach(function(k){k=c.chunkGraph.getChunkModulesIterable(k);
Array.from(k).forEach(function(f){const q=c.chunkGraph.getModuleId(f);h(q,f);f.modules&&f.modules.forEach(u=>{h(q,u)})})})});var d=JSON.stringify(a,null,2);c.emitAsset(l.clientManifestFilename,new C.sources.RawSource(d,!1));d=JSON.stringify(e,null,2);c.emitAsset(l.ssrManifestFilename,new C.sources.RawSource(d,!1))}})})}resolveAllClientFiles(b,l,n,t,c){y.map(this.clientReferences,(a,e)=>{"string"===typeof a?e(null,[new E(a)]):l.resolve({},b,a.directory,{},(d,g)=>{if(d)return e(d);t.resolveDependencies(n,
{resource:g,resourceQuery:"",recursive:void 0===a.recursive?!0:a.recursive,regExp:a.include,include:void 0,exclude:a.exclude},(h,m)=>{if(h)return e(h);h=m.map(k=>{var f=p.join(g,k.userRequest);f=new E(f);f.userRequest=k.userRequest;return f});e(null,h)})})},(a,e)=>{if(a)return c(a);a=[];for(let d=0;d<e.length;d++)a.push.apply(a,e[d]);c(null,a)})}}module.exports=G;
